@page "/debug-logs"
@attribute [Authorize("Admin")]
@using MihuBot.RuntimeUtils;
@using System.Collections.Concurrent;
@inject Logger Logger
@inject InitializedDiscordClient Discord
@implements IDisposable

<pre><code>
    @_logs
</code></pre>

@code
{
    private const int NumLines = 40;
    private const int MaxLineLength = 200;

    private readonly CancellationTokenSource _cts = new();
    private string _logs;

    protected override void OnInitialized()
    {
        _ = Task.Run(async () =>
        {
            try
            {
                await Discord.EnsureInitializedAsync();

                DateTime since = DateTime.UtcNow - TimeSpan.FromMinutes(1);

                var sb = new StringBuilder(NumLines * MaxLineLength);
                using var timer = new PeriodicTimer(TimeSpan.FromMilliseconds(250));

                while (await timer.WaitForNextTickAsync(_cts.Token))
                {
                    var logs = await Logger.GetLogsAsync(since, DateTime.UtcNow, query: q => q.Take(NumLines * 2));

                    if (logs.Length > NumLines)
                    {
                        logs = logs.AsSpan(logs.Length - NumLines).ToArray();
                        since = logs[0].Timestamp;
                    }
                    else if (logs.Length < NumLines)
                    {
                        since = DateTime.UtcNow - ((DateTime.UtcNow - since) * 1.2);
                    }

                    foreach (var log in logs)
                    {
                        int beforeLength = sb.Length;
                        log.ToString(sb, Discord);

                        if (sb.Length - beforeLength > MaxLineLength)
                        {
                            sb.Length = beforeLength + MaxLineLength - 4;
                            sb.Append(" ...");
                        }

                        sb.AppendLine();
                    }

                    string newLogs = sb.ToString();
                    sb.Length = 0;

                    if (_logs != newLogs)
                    {
                        _logs = newLogs;
                        _ = InvokeAsync(StateHasChanged);
                    }
                }
            }
            catch { }
        });
    }

    public void Dispose()
    {
        _cts.Cancel();
    }
}
